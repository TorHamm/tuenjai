<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>เตือนใจ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,sans-serif;padding:16px}
    .muted{color:#666}
  </style>
</head>
<body>
  <h3 id="t">กำลังเข้าสู่ระบบ…</h3>
  <p class="muted" id="d"></p>

<script>
  const LIFF_ID = "2009019120-2LfYAK9n";
  const API_BASE = "https://tuenjai-bot.tor-newacc.workers.dev";

  async function main() {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.origin + "/" });
      return;
    }

    const idToken = liff.getIDToken();
    if (!idToken) {
      document.getElementById("t").textContent = "ไม่พบ ID Token";
      return;
    }

    const res = await fetch(`${API_BASE}/auth/liff`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idToken })
    });

    const txt = await res.text();
    if (!res.ok) {
      document.getElementById("t").textContent = `ล็อกอินไม่สำเร็จ (${res.status})`;
      document.getElementById("d").textContent = txt;
      return;
    }

    const data = JSON.parse(txt);
    if (!data.sessionToken) {
      document.getElementById("t").textContent = "ไม่ได้รับ sessionToken";
      document.getElementById("d").textContent = txt;
      return;
    }

    localStorage.setItem("sessionToken", data.sessionToken);

    // go to actual app
    location.href = "/app.html";
  }

  main().catch(err => {
    document.getElementById("t").textContent = "เกิดข้อผิดพลาด";
    document.getElementById("d").textContent = String(err?.message || err);
  });
</script>
</body>
</html>
